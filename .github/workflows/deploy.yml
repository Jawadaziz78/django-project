name: Deployment Pipeline

on:
  push:
    branches: [ "development", "stage", "test" ]

env:
  PROJECT_TYPE: 'laravel'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Execute Pipeline
        id: deploy_step
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PROJECT_TYPE
          script: |
            set -e
            BRANCH=${{ github.ref_name }}
            
            # 1. INITIALIZATION
            echo "STAGE_NAME=Initialization"
            echo "--- üöÄ Starting Deployment for $BRANCH branch ---"
            cd /var/www/html/$BRANCH/$PROJECT_TYPE-project
            git pull origin $BRANCH
            echo "‚úÖ Initialization: DONE"

            # 2. SONARQUBE ANALYSIS
            echo "STAGE_NAME=SonarQube Analysis"
            echo "--- üîç Running SonarQube Analysis ---"
            export SONAR_NODE_ARGS='--max-old-space-size=512'
            /home/ubuntu/sonar-scanner/bin/sonar-scanner \
              -Dsonar.projectKey=${PROJECT_TYPE}-project \
              -Dsonar.sources=app \
              -Dsonar.inclusions=**/*.php \
              -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
              -Dsonar.login=${{ secrets.SONAR_TOKEN }}
            echo "‚úÖ SonarQube Analysis: DONE"

            # 3. QUALITY GATE
            echo "STAGE_NAME=Quality Gate"
            echo "--- üö¶ Checking Quality Gate Status ---"
            sleep 10
            for i in {1..24}; do
              STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: "${{ secrets.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=${PROJECT_TYPE}-project" | jq -r '.projectStatus.status')
              if [ "$STATUS" = "OK" ] || [ "$STATUS" = "ERROR" ]; then break; fi
              echo "Current Status: $STATUS (waiting...)"
              sleep 5
            done
            echo "‚úÖ Quality Gate Check: DONE (Status: $STATUS)"

            # 4. SAFETY CHECK
            if [ "$STATUS" != "OK" ]; then 
              echo "‚ùå ERROR: Quality Gate failed. Aborting deployment."
              exit 1 
            fi

            # 5. BUILD AND DEPLOY
            echo "STAGE_NAME=Build and Deploy"
            echo "--- üõ† Starting Build and Deploy for $PROJECT_TYPE ---"
            case "$PROJECT_TYPE" in
                vue) 
                  VITE_BASE_URL="/$PROJECT_TYPE/$BRANCH/" 
                  BASE_URL="/$PROJECT_TYPE/$BRANCH/" 
                  npm run build 
                  ;;
                nextjs) 
                  npm run build 
                  pm2 restart $PROJECT_TYPE-$BRANCH 
                  ;;
                laravel) 
                  sudo php artisan optimize
                  ;;
            esac
            echo "‚úÖ Build and Deploy: DONE"
            echo "--- üéâ Pipeline Execution Finished Successfully ---"

      # ========================================================================
      # SLACK NOTIFICATION (Fixed & Clean)
      # ========================================================================
      - name: Slack Notification
        if: always()
        env:
          # CRITICAL: This maps the secret to the script.
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ "${{ steps.deploy_step.outcome }}" == "success" ]; then
            TEXT="‚úÖ *Deployment Successful*\nüìÇ *Project:* ${{ env.PROJECT_TYPE }}\nüåø *Branch:* ${{ github.ref_name }}\nüöÄ *Status:* Live"
          else
            # Attempts to find the stage name from logs
            FAILED_STAGE=$(echo "${{ steps.deploy_step.outputs.stdout }}" | grep "STAGE_NAME=" | tail -1 | cut -d'=' -f2)
            
            # Message strictly formatted as requested (No log link)
            TEXT="‚ùå *Pipeline Failed*\nüìÇ *Project:* ${{ env.PROJECT_TYPE }}\nüåø *Branch:* ${{ github.ref_name }}\nüí• *Failed Stage:* ${FAILED_STAGE:-Execute Pipeline}"
          fi
          
          # Debug line to confirm Secret is loaded
          if [ -z "$WEBHOOK_URL" ]; then echo "‚ùå Debug: Webhook URL is empty!"; else echo "‚úÖ Debug: Webhook URL is set."; fi

          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$TEXT\"}" "$WEBHOOK_URL"
